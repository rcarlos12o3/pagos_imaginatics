name: Run Database Migrations

# Este workflow SOLO se ejecuta manualmente
# NUNCA se ejecuta automÃ¡ticamente para evitar pÃ©rdida de datos
on:
  workflow_dispatch:
    inputs:
      confirm_migrations:
        description: 'Escribe "EJECUTAR MIGRACIONES" para confirmar'
        required: true
        type: string

jobs:
  validate-confirmation:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_migrations }}" != "EJECUTAR MIGRACIONES" ]; then
            echo "âŒ Error: Debes escribir exactamente 'EJECUTAR MIGRACIONES' para confirmar"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n vÃ¡lida"

  backup-database:
    runs-on: ubuntu-latest
    needs: validate-confirmation
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create Backup
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  CREANDO BACKUP DE SEGURIDAD           â•‘"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo ""

            ./scripts/backup_database.sh || {
              echo "âŒ Error al crear backup"
              exit 1
            }

            echo ""
            echo "âœ… Backup creado exitosamente"
          EOF

  run-migrations:
    runs-on: ubuntu-latest
    needs: backup-database
    environment: production-migrations

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Check Migration Status
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ESTADO DE MIGRACIONES                 â•‘"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo ""

            ./scripts/migrate.sh --status
          EOF

      - name: Run Migrations with Safety Checks
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.PROJECT_PATH }}

            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  EJECUTANDO MIGRACIONES                â•‘"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo ""

            # El script migrate.sh automÃ¡ticamente:
            # 1. Valida cada migraciÃ³n (bloquea comandos peligrosos)
            # 2. Crea backup antes de cada migraciÃ³n
            # 3. Registra migraciones aplicadas
            # 4. Permite rollback en caso de error

            ./scripts/migrate.sh --all || {
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  âŒ ERROR EN MIGRACIÃ“N                 â•‘"
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo ""
              echo "ðŸ“‹ Backup disponible en: backups/auto/"
              echo ""
              echo "ðŸ”„ Para hacer ROLLBACK:"
              echo "   ssh al servidor y ejecuta:"
              echo "   cd ${{ secrets.PROJECT_PATH }}"
              echo "   ./scripts/rollback_database.sh"
              echo ""
              exit 1
            }

            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… MIGRACIONES COMPLETADAS            â•‘"
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo ""

            # Mostrar estado final
            ./scripts/migrate.sh --status
          EOF

      - name: Verify Application Health
        run: |
          echo "ðŸ¥ Verificando salud de la aplicaciÃ³n..."
          curl -f http://${{ secrets.SERVER_HOST }}:8080 || {
            echo "âŒ La aplicaciÃ³n no responde"
            echo "âš ï¸  Considera hacer rollback"
            exit 1
          }
          echo "âœ… AplicaciÃ³n funcionando correctamente"

  notify-success:
    runs-on: ubuntu-latest
    needs: run-migrations
    if: success()
    steps:
      - name: Success Notification
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸŽ‰ MIGRACIONES EXITOSAS               â•‘"
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo ""
          echo "âœ… Todas las migraciones se ejecutaron correctamente"
          echo "âœ… La aplicaciÃ³n estÃ¡ funcionando"
          echo "ðŸ“Š Backups guardados en backups/auto/"
          echo ""

  notify-failure:
    runs-on: ubuntu-latest
    needs: run-migrations
    if: failure()
    steps:
      - name: Failure Notification
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âŒ MIGRACIONES FALLIDAS               â•‘"
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo ""
          echo "âš ï¸  Las migraciones fallaron"
          echo "ðŸ“‹ Backups disponibles en backups/auto/"
          echo ""
          echo "ðŸ”„ Para hacer ROLLBACK:"
          echo "   1. SSH al servidor"
          echo "   2. cd ${{ secrets.PROJECT_PATH }}"
          echo "   3. ./scripts/rollback_database.sh"
          echo ""
